#!/bin/bash

# Setup Azure Developer CLI (azd) Script
# Simple setup script for AI agents lab

set -e  # Exit on any error

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

# ---------------------
# Check Prerequisites
# ---------------------

echo "→ Checking prerequisites..."

# Check if azd is installed
if ! command -v azd >/dev/null 2>&1; then
    print_error "Azure Developer CLI (azd) is not installed"
    echo "Please install azd first: https://learn.microsoft.com/azure/developer/azure-developer-cli/install-azd"
    exit 1
else
    azd_version=$(azd version | head -n 1)
    print_success "Azure Developer CLI found: $azd_version"
fi

# Check if az is installed
if ! command -v az >/dev/null 2>&1; then
    print_error "Azure CLI (az) is not installed"
    echo "Please install Azure CLI first: https://docs.microsoft.com/cli/azure/install-azure-cli"
    exit 1
else
    az_version=$(az version --query '"azure-cli"' -o tsv)
    print_success "Azure CLI found: $az_version"
fi

# ---------------------
# Setup .azd-setup Directory
# ---------------------

echo "→ Setting up .azd-setup directory..."

if [ ! -d ".azd-setup" ]; then
    mkdir -p .azd-setup
    print_success "Created .azd-setup directory"
else
    print_success ".azd-setup directory already exists"
fi

# ---------------------
# Initialize AI Agents Template
# ---------------------

echo "→ Initializing AI agents template..."

cd .azd-setup

# Initialize with the AI agents template using AI-AGENTS-AZD as environment name
azd init -t get-started-with-ai-agents -e AI-AGENTS-AZD

print_success "AI agents template initialized successfully with environment: AI-AGENTS-AZD"

# Enable Azure Monitor tracing
azd env set ENABLE_AZURE_MONITOR_TRACING true

print_success "Azure Monitor tracing enabled"

# Enable Azure tracing Gen AI content recording
azd env set AZURE_TRACING_GEN_AI_CONTENT_RECORDING_ENABLED true

print_success "Azure tracing Gen AI content recording enabled"

# Set Azure location
azd env set AZURE_LOCATION swedencentral

print_success "Azure location set to swedencentral"

# Set Azure AI agent model configuration
azd env set AZURE_AI_AGENT_MODEL_NAME gpt-4.1
azd env set AZURE_AI_AGENT_MODEL_VERSION 2025-04-14
azd env set AZURE_AI_AGENT_DEPLOYMENT_NAME gpt-4.1

print_success "Azure AI agent model configured: gpt-4.1 (version: 2025-04-14)"

# Set Azure AI agent deployment capacity
azd env set AZURE_AI_AGENT_DEPLOYMENT_CAPACITY 100
azd env set AZURE_AI_EMBED_DEPLOYMENT_CAPACITY 50

print_success "Azure AI agent deployment capacity set to 100"
print_success "Azure AI embed deployment capacity set to 50"

# Set Azure AI Search configuration
azd env set USE_AZURE_AI_SEARCH_SERVICE true
azd env set AZURE_AI_SEARCH_INDEX_NAME "zava-products"
azd env set AZURE_AI_EMBED_DEPLOYMENT_NAME "text-embedding-3-large"
azd env set AZURE_AI_EMBED_MODEL_NAME "text-embedding-3-large"

print_success "Azure AI Search configuration set"

# ---------------------
# Install Python Dependencies
# ---------------------

echo "→ Installing Python dependencies..."

# Go back to the root directory
cd ..

# Check if the .azd-setup requirements exist before installing
if [ -f ".azd-setup/requirements-dev.txt" ]; then
    pip install -r .azd-setup/requirements-dev.txt
    print_success "Installed .azd-setup/requirements-dev.txt dependencies"
else
    print_warning ".azd-setup/requirements-dev.txt not found, skipping"
fi

# Check if the .azd-setup src directory exists before installing in editable mode
if [ -d ".azd-setup/src" ]; then
    pip install -e .azd-setup/src
    print_success "Installed .azd-setup/src in editable mode"
else
    print_warning ".azd-setup/src directory not found, skipping editable install"
fi

echo ""
print_success "Setup complete! You can now work with the AI agents template."