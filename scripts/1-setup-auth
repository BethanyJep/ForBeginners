#!/bin/bash

# Setup Authentication Script
# Authentication setup script for AI agents lab

set -e  # Exit on any error

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

# ---------------------
# Check Prerequisites
# ---------------------

echo "→ Checking prerequisites..."

# Check if azd is installed
if ! command -v azd >/dev/null 2>&1; then
    print_error "Azure Developer CLI (azd) is not installed"
    echo "Please install azd first: https://learn.microsoft.com/azure/developer/azure-developer-cli/install-azd"
    exit 1
else
    azd_version=$(azd version | head -n 1)
    print_success "Azure Developer CLI found: $azd_version"
fi

# Check if az is installed
if ! command -v az >/dev/null 2>&1; then
    print_error "Azure CLI (az) is not installed"
    echo "Please install Azure CLI first: https://docs.microsoft.com/cli/azure/install-azure-cli"
    exit 1
else
    az_version=$(az version --query '"azure-cli"' -o tsv)
    print_success "Azure CLI found: $az_version"
fi

# ---------------------
# Azure CLI Authentication
# ---------------------

echo "→ Setting up Azure CLI authentication..."

# Check if already logged in to Azure CLI
if az account show >/dev/null 2>&1; then
    print_warning "Already logged in to Azure CLI"
    current_account=$(az account show --query 'name' -o tsv)
    print_success "Current Azure CLI account: $current_account"
else
    echo "Logging in to Azure CLI..."
    az login
    current_account=$(az account show --query 'name' -o tsv)
    print_success "Successfully logged in to Azure CLI: $current_account"
fi

# ---------------------
# Azure Developer CLI Authentication
# ---------------------

echo "→ Setting up Azure Developer CLI authentication..."

# Check if already logged in to Azure Developer CLI
if azd auth login --check-status >/dev/null 2>&1; then
    print_warning "Already logged in to Azure Developer CLI"
    print_success "Azure Developer CLI authentication verified"
else
    echo "Logging in to Azure Developer CLI..."
    azd auth login
    print_success "Successfully logged in to Azure Developer CLI"
fi

# ---------------------
# Display Login Status
# ---------------------

echo ""
echo "→ Current authentication status:"

# Azure CLI status
echo ""
echo "Azure CLI:"
if az account show >/dev/null 2>&1; then
    account_name=$(az account show --query 'name' -o tsv)
    subscription_id=$(az account show --query 'id' -o tsv)
    tenant_id=$(az account show --query 'tenantId' -o tsv)
    user_name=$(az account show --query 'user.name' -o tsv)
    
    print_success "Logged in as: $user_name"
    print_success "Subscription: $account_name ($subscription_id)"
    print_success "Tenant ID: $tenant_id"
else
    print_error "Not logged in to Azure CLI"
fi

# Azure Developer CLI status
echo ""
echo "Azure Developer CLI:"
if azd auth login --check-status >/dev/null 2>&1; then
    print_success "Authentication verified"
else
    print_error "Not logged in to Azure Developer CLI"
fi

echo ""
print_success "Authentication setup complete!"